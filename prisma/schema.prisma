// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  EDITOR
  VIEWER
}

enum SpendSource {
  MANUAL
  BULK_PASTE
}

enum AuditAction {
  CREATE
  OVERWRITE
  DELETE
}

model User {
  id        String   @id
  email     String   @unique
  name      String?
  avatarUrl String?
  createdAt DateTime @default(now())

  memberships         Membership[]
  createdSpendEntries SpendEntry[] @relation("UserCreatedSpendEntries")
  spendAudits         SpendAudit[] @relation("UserSpendAudits")
}

model Org {
  id         String   @id @default(cuid())
  externalId String   @unique // Clerk organization.id
  name       String
  createdAt  DateTime @default(now())

  memberships  Membership[]
  spendEntries SpendEntry[]
  spendAudits  SpendAudit[]
}

model Membership {
  id        String   @id @default(cuid())
  orgId     String
  userId    String
  role      Role     @default(VIEWER)
  createdAt DateTime @default(now())

  org  Org  @relation(fields: [orgId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@unique([orgId, userId])
  @@index([userId])
}

model Platform {
  id        String   @id @default(cuid())
  key       String
  name      String
  createdAt DateTime @default(now())

  spendEntries SpendEntry[]

  @@unique([key])
}

model SpendEntry {
  id    String @id @default(cuid())
  orgId String

  platformId String
  platform   Platform @relation(fields: [platformId], references: [id])
  platformKey String

  date        DateTime
  amountCents Int
  currency    String   @default("USD")

  source SpendSource @default(MANUAL)
  notes  String?

  createdByUserId String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  org         Org          @relation(fields: [orgId], references: [id])
  createdBy   User?        @relation("UserCreatedSpendEntries", fields: [createdByUserId], references: [id])
  spendAudits SpendAudit[]

  @@index([orgId, date])
  @@index([orgId, platformId, date])
  @@index([orgId, platformKey, date])
  @@unique([orgId, platformKey, date])
}

model SpendAudit {
  id           String      @id @default(cuid())
  orgId        String
  spendEntryId String?
  action       AuditAction
  beforeJson   Json?
  afterJson    Json?
  actorUserId  String
  createdAt    DateTime    @default(now())

  org        Org         @relation(fields: [orgId], references: [id])
  actor      User        @relation("UserSpendAudits", fields: [actorUserId], references: [id])
  spendEntry SpendEntry? @relation(fields: [spendEntryId], references: [id])

  @@index([orgId, spendEntryId])
  @@index([orgId, createdAt])
  @@index([actorUserId, createdAt])
}
